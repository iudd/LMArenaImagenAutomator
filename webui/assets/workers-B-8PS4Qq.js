import{j as ne,l as S,o as se,r as b,b as W,d as i,w as s,c as n,f as o,e as r,g as v,h as p,i as y,t as x,F as A,m as re}from"./index-CdkAYAR1.js";const ie={style:{"margin-bottom":"24px"}},ue={style:{"margin-bottom":"8px"}},pe={style:{"margin-bottom":"8px"}},de={style:{display:"flex","justify-content":"flex-end","margin-top":"24px"}},ve={style:{display:"flex","justify-content":"space-between","align-items":"center"}},me={key:0},ye={key:3},xe=["onClick"],ge=["onClick"],fe={style:{"margin-bottom":"24px"}},ke={style:{"margin-bottom":"16px"}},we={style:{"margin-bottom":"16px"}},be={style:{"margin-bottom":"16px"}},_e={style:{"margin-bottom":"16px"}},ce={style:{"margin-left":"8px"}},Ce={key:0,style:{"margin-bottom":"16px"}},Me={key:1,style:{"margin-bottom":"16px"}},Ue={key:2,style:{"margin-bottom":"16px"}},he={key:3,style:{"margin-bottom":"16px"}},Te={style:{"margin-left":"8px"}},Pe={key:4,style:{"margin-bottom":"16px"}},De={key:5,style:{"margin-bottom":"16px"}},Se={style:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"8px"}},We=["onClick"],Ae=["onClick"],$e={style:{"font-weight":"600"}},ze={style:{"font-size":"12px",color:"#8c8c8c"}},Ie={key:0},He={key:0},je={style:{"text-align":"right"}},Fe={style:{"margin-bottom":"16px"}},Ve={style:{"margin-bottom":"16px"}},Be={style:{"margin-bottom":"16px"}},Ee={style:{"margin-bottom":"16px"}},Le={__name:"workers",setup(Ne){const d=ne(),g=S({get:()=>d.poolConfig,set:a=>d.poolConfig=a}),j=async()=>{await d.savePoolConfig(g.value)};se(async()=>{await Promise.all([d.fetchWorkerConfig(),d.fetchPoolConfig(),d.fetchAdaptersMeta()])});const $=S(()=>{const a=d.adaptersMeta.map(e=>({label:e.name,value:e.id}));return a.find(e=>e.value==="merge")||a.push({label:"Merge（聚合模式）",value:"merge"}),a}),F=[{title:"实例名称",dataIndex:"name",key:"name"},{title:"Worker 数量",dataIndex:"workerCount",key:"workerCount"},{title:"代理",dataIndex:"proxy",key:"proxy"},{title:"数据标记",key:"userDataMark",dataIndex:"userDataMark"},{title:"操作",key:"action"}],h=S({get:()=>d.workerConfig,set:a=>{d.workerConfig=a}}),k=b(!1),f=b(null),l=b({name:"",userDataMark:"",proxy:!1,proxyType:"socks5",proxyHost:"",proxyPort:1080,proxyAuth:!1,proxyUsername:"",proxyPassword:"",workers:[]}),V=()=>{f.value=null;const a=Math.random().toString(36).substring(2,7);l.value={name:`instance-${(h.value||[]).length+1}-${a}`,userDataMark:"",proxy:!1,proxyType:"socks5",proxyHost:"",proxyPort:1080,proxyAuth:!1,proxyUsername:"",proxyPassword:"",workers:[]},k.value=!0},B=a=>{f.value=a,l.value={name:a.name,userDataMark:a.userDataMark||"",proxy:!!a.proxy,proxyType:a.proxy?.type||"socks5",proxyHost:a.proxy?.host||"",proxyPort:a.proxy?.port||1080,proxyAuth:a.proxy?.auth||!1,proxyUsername:a.proxy?.username||"",proxyPassword:a.proxy?.password||"",workers:a.workers?[...a.workers]:[]},(a.proxy===null||a.proxy===void 0)&&(l.value.proxy=!1),k.value=!0},E=async a=>{const e=h.value.filter(C=>C.id!==a.id);await d.saveWorkerConfig(e)},N=async()=>{const a={id:f.value?f.value.id:`inst_${Date.now()}`,name:l.value.name,userDataMark:l.value.userDataMark,workers:l.value.workers,proxy:l.value.proxy?{enable:!0,type:l.value.proxyType,host:l.value.proxyHost,port:l.value.proxyPort,auth:l.value.proxyAuth,username:l.value.proxyUsername,password:l.value.proxyPassword}:null};let e=[...h.value||[]];if(f.value===null)e.push(a);else{const w=e.findIndex(T=>T.id===f.value.id);w>-1&&(e[w]=a)}await d.saveWorkerConfig(e)&&(k.value=!1)},_=b(-1),c=b(!1),u=b({name:"",type:"lmarena",mergeTypes:[],mergeMonitor:""}),O=()=>{_.value=-1;const a=Math.random().toString(36).substring(2,7);u.value={name:`worker-${l.value.workers.length+1}-${a}`,type:"lmarena",mergeTypes:[],mergeMonitor:""},c.value=!0},L=a=>{_.value=a;const e=l.value.workers[a];u.value={name:e.name,type:e.type,mergeTypes:e.mergeTypes?[...e.mergeTypes]:[],mergeMonitor:e.mergeMonitor||""},c.value=!0},R=()=>{_.value===-1?l.value.workers.push({...u.value}):l.value.workers[_.value]={...u.value},c.value=!1},K=a=>{l.value.workers.splice(a,1)};return(a,e)=>{const C=r("a-segmented"),w=r("a-switch"),T=r("a-col"),z=r("a-input-number"),q=r("a-row"),M=r("a-button"),I=r("a-card"),G=r("a-tag"),J=r("a-divider"),Q=r("a-table"),U=r("a-input"),X=r("a-input-password"),Y=r("a-collapse-panel"),Z=r("a-collapse"),ee=r("a-list-item"),te=r("a-list"),oe=r("a-drawer"),P=r("a-select"),H=r("a-select-option"),le=r("a-modal"),ae=r("a-layout");return i(),W(ae,{style:{background:"transparent"}},{default:s(()=>[n(I,{title:"负载均衡",bordered:!1,style:{width:"100%","margin-bottom":"10px"}},{default:s(()=>[o("div",ie,[e[19]||(e[19]=o("div",{style:{"font-weight":"600","margin-bottom":"8px"}},"调度策略",-1)),e[20]||(e[20]=o("div",{style:{"font-size":"12px",color:"#8c8c8c","margin-bottom":"12px"}}," 选择任务分配到工作实例的调度算法 ",-1)),n(C,{value:g.value.strategy,"onUpdate:value":e[0]||(e[0]=t=>g.value.strategy=t),block:"",options:[{label:"最少繁忙",value:"least_busy"},{label:"轮询",value:"round_robin"},{label:"随机",value:"random"}]},null,8,["value"])]),n(q,{gutter:16},{default:s(()=>[n(T,{xs:24,md:12},{default:s(()=>[o("div",ue,[e[21]||(e[21]=o("div",{style:{"font-weight":"600","margin-bottom":"8px"}},"故障转移",-1)),e[22]||(e[22]=o("div",{style:{"font-size":"12px",color:"#8c8c8c","margin-bottom":"12px"}}," 启用后，任务失败时会自动切换到其他可用实例重试 ",-1)),n(w,{checked:g.value.failover.enabled,"onUpdate:checked":e[1]||(e[1]=t=>g.value.failover.enabled=t)},null,8,["checked"])])]),_:1}),n(T,{xs:24,md:12},{default:s(()=>[o("div",pe,[e[23]||(e[23]=o("div",{style:{"font-weight":"600","margin-bottom":"8px"}},"重试次数",-1)),e[24]||(e[24]=o("div",{style:{"font-size":"12px",color:"#8c8c8c","margin-bottom":"12px"}}," 故障转移时最大重试次数，范围 1-10 ",-1)),n(z,{value:g.value.failover.maxRetries,"onUpdate:value":e[2]||(e[2]=t=>g.value.failover.maxRetries=t),min:1,max:10,disabled:!g.value.failover.enabled,style:{width:"100%"},placeholder:"请输入重试次数"},null,8,["value","disabled"])])]),_:1})]),_:1}),o("div",de,[n(M,{type:"primary",onClick:j},{default:s(()=>[...e[25]||(e[25]=[v(" 保存设置 ",-1)])]),_:1})])]),_:1}),n(I,{bordered:!1,style:{width:"100%"}},{title:s(()=>[o("div",ve,[e[27]||(e[27]=o("span",null,"实例列表",-1)),n(M,{type:"primary",onClick:V},{default:s(()=>[...e[26]||(e[26]=[v(" 创建实例 ",-1)])]),_:1})])]),default:s(()=>[n(Q,{columns:F,"data-source":h.value,pagination:!1},{bodyCell:s(({column:t,record:m})=>[t.key==="name"?(i(),p("a",me,x(m.name),1)):t.key==="workerCount"?(i(),p(A,{key:1},[v(x(m.workers?m.workers.length:0),1)],64)):t.key==="proxy"?(i(),W(G,{key:2,color:m.proxy?"green":"default"},{default:s(()=>[v(x(m.proxy?"已启用":"未启用"),1)]),_:2},1032,["color"])):t.key==="action"?(i(),p("span",ye,[o("a",{onClick:D=>B(m)},"编辑",8,xe),n(J,{type:"vertical"}),o("a",{style:{color:"#ff4d4f"},onClick:D=>E(m)},"删除",8,ge)])):y("",!0)]),_:1},8,["data-source"])]),_:1}),n(oe,{open:k.value,"onUpdate:open":e[13]||(e[13]=t=>k.value=t),title:f.value===null?"创建实例":`编辑实例 - ${f.value.name}`,placement:"right",width:"500"},{footer:s(()=>[o("div",je,[n(M,{style:{"margin-right":"8px"},onClick:e[12]||(e[12]=t=>k.value=!1)},{default:s(()=>[...e[40]||(e[40]=[v("取消",-1)])]),_:1}),n(M,{type:"primary",onClick:N},{default:s(()=>[...e[41]||(e[41]=[v("保存",-1)])]),_:1})])]),default:s(()=>[o("div",fe,[o("div",ke,[e[28]||(e[28]=o("div",{style:{"font-weight":"600","margin-bottom":"4px"}},"实例名称",-1)),e[29]||(e[29]=o("div",{style:{"font-size":"12px",color:"#ff4d4f","margin-bottom":"8px"}}," * 名称必须全局唯一，不可重复 ",-1)),n(U,{value:l.value.name,"onUpdate:value":e[3]||(e[3]=t=>l.value.name=t),placeholder:"请输入实例名称"},null,8,["value"])]),o("div",we,[e[30]||(e[30]=o("div",{style:{"font-weight":"600","margin-bottom":"4px"}},"数据标记",-1)),e[31]||(e[31]=o("div",{style:{"font-size":"12px",color:"#8c8c8c","margin-bottom":"8px"}}," 用于区分实例数据存储的文件夹名称 (userDataMark) ",-1)),n(U,{value:l.value.userDataMark,"onUpdate:value":e[4]||(e[4]=t=>l.value.userDataMark=t),placeholder:"请输入数据标记，如: main-gemini"},null,8,["value"])]),o("div",be,[n(Z,null,{default:s(()=>[n(Y,{key:"proxy",header:"代理设置"},{default:s(()=>[o("div",_e,[n(w,{checked:l.value.proxy,"onUpdate:checked":e[5]||(e[5]=t=>l.value.proxy=t)},null,8,["checked"]),o("span",ce,x(l.value.proxy?"已启用代理":"未启用代理"),1)]),l.value.proxy?(i(),p("div",Ce,[e[32]||(e[32]=o("div",{style:{"font-weight":"600","margin-bottom":"8px"}},"代理类型",-1)),n(C,{value:l.value.proxyType,"onUpdate:value":e[6]||(e[6]=t=>l.value.proxyType=t),block:"",options:[{label:"SOCKS5",value:"socks5"},{label:"HTTP",value:"http"}],style:{width:"100%"}},null,8,["value"])])):y("",!0),l.value.proxy?(i(),p("div",Me,[e[33]||(e[33]=o("div",{style:{"font-weight":"600","margin-bottom":"8px"}},"服务器地址",-1)),n(U,{value:l.value.proxyHost,"onUpdate:value":e[7]||(e[7]=t=>l.value.proxyHost=t),placeholder:"例如: 127.0.0.1"},null,8,["value"])])):y("",!0),l.value.proxy?(i(),p("div",Ue,[e[34]||(e[34]=o("div",{style:{"font-weight":"600","margin-bottom":"8px"}},"端口",-1)),n(z,{value:l.value.proxyPort,"onUpdate:value":e[8]||(e[8]=t=>l.value.proxyPort=t),min:1,max:65535,style:{width:"100%"},placeholder:"例如: 1080"},null,8,["value"])])):y("",!0),l.value.proxy?(i(),p("div",he,[e[35]||(e[35]=o("div",{style:{"font-weight":"600","margin-bottom":"8px"}},"身份验证",-1)),n(w,{checked:l.value.proxyAuth,"onUpdate:checked":e[9]||(e[9]=t=>l.value.proxyAuth=t)},null,8,["checked"]),o("span",Te,x(l.value.proxyAuth?"需要验证":"无需验证"),1)])):y("",!0),l.value.proxy&&l.value.proxyAuth?(i(),p("div",Pe,[e[36]||(e[36]=o("div",{style:{"font-weight":"600","margin-bottom":"8px"}},"用户名",-1)),n(U,{value:l.value.proxyUsername,"onUpdate:value":e[10]||(e[10]=t=>l.value.proxyUsername=t),placeholder:"请输入用户名"},null,8,["value"])])):y("",!0),l.value.proxy&&l.value.proxyAuth?(i(),p("div",De,[e[37]||(e[37]=o("div",{style:{"font-weight":"600","margin-bottom":"8px"}},"密码",-1)),n(X,{value:l.value.proxyPassword,"onUpdate:value":e[11]||(e[11]=t=>l.value.proxyPassword=t),placeholder:"请输入密码"},null,8,["value"])])):y("",!0)]),_:1})]),_:1})]),o("div",null,[o("div",Se,[e[39]||(e[39]=o("div",{style:{"font-weight":"600"}},"Worker 列表",-1)),n(M,{size:"small",type:"primary",onClick:O},{default:s(()=>[...e[38]||(e[38]=[v(" 添加 Worker ",-1)])]),_:1})]),n(te,{bordered:"","data-source":l.value.workers,style:{"margin-top":"8px"}},{renderItem:s(({item:t,index:m})=>[n(ee,null,{actions:s(()=>[o("a",{onClick:D=>L(m)},"编辑",8,We),o("a",{style:{color:"#ff4d4f"},onClick:D=>K(m)},"删除",8,Ae)]),default:s(()=>[o("div",null,[o("div",$e,x(t.name),1),o("div",ze,[v(" 类型: "+x(t.type)+" ",1),t.type==="merge"?(i(),p("span",Ie,[v(" | 聚合: "+x(t.mergeTypes?.join(", ")||"无")+" ",1),t.mergeMonitor?(i(),p("span",He," | 监控: "+x(t.mergeMonitor),1)):y("",!0)])):y("",!0)])])]),_:2},1024)]),_:1},8,["data-source"])])])]),_:1},8,["open","title"]),n(le,{open:c.value,"onUpdate:open":e[18]||(e[18]=t=>c.value=t),title:_.value===-1?"添加 Worker":"编辑 Worker",okText:"确定",cancelText:"取消",onOk:R},{default:s(()=>[o("div",Fe,[e[42]||(e[42]=o("div",{style:{"font-weight":"600","margin-bottom":"4px"}},"Worker 名称",-1)),e[43]||(e[43]=o("div",{style:{"font-size":"12px",color:"#ff4d4f","margin-bottom":"8px"}}," * 名称必须全局唯一，不可重复 ",-1)),n(U,{value:u.value.name,"onUpdate:value":e[14]||(e[14]=t=>u.value.name=t),placeholder:"例如: default"},null,8,["value"])]),o("div",Ve,[e[44]||(e[44]=o("div",{style:{"font-weight":"600","margin-bottom":"8px"}},"适配器类型",-1)),n(P,{value:u.value.type,"onUpdate:value":e[15]||(e[15]=t=>u.value.type=t),style:{width:"100%"},options:$.value},null,8,["value","options"])]),u.value.type==="merge"?(i(),p(A,{key:0},[o("div",Be,[e[45]||(e[45]=o("div",{style:{"font-weight":"600","margin-bottom":"4px"}},"聚合类型",-1)),e[46]||(e[46]=o("div",{style:{"font-size":"12px",color:"#8c8c8c","margin-bottom":"8px"}}," 选择要聚合的后端适配器（可多选） ",-1)),n(P,{value:u.value.mergeTypes,"onUpdate:value":e[16]||(e[16]=t=>u.value.mergeTypes=t),mode:"multiple",style:{width:"100%"},placeholder:"选择要聚合的适配器",options:$.value},null,8,["value","options"])]),o("div",Ee,[e[48]||(e[48]=o("div",{style:{"font-weight":"600","margin-bottom":"4px"}},"空闲监控后端",-1)),e[49]||(e[49]=o("div",{style:{"font-size":"12px",color:"#8c8c8c","margin-bottom":"8px"}}," 空闲时挂机监控的后端（可选） ",-1)),n(P,{value:u.value.mergeMonitor,"onUpdate:value":e[17]||(e[17]=t=>u.value.mergeMonitor=t),style:{width:"100%"},placeholder:"选择监控后端（可留空）","allow-clear":""},{default:s(()=>[n(H,{value:""},{default:s(()=>[...e[47]||(e[47]=[v("无",-1)])]),_:1}),(i(!0),p(A,null,re(u.value.mergeTypes,t=>(i(),W(H,{key:t,value:t},{default:s(()=>[v(x(t),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])],64)):y("",!0)]),_:1},8,["open","title"])]),_:1})}}};export{Le as default};
